name: XServer GAME Auto Renew

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´22:35è¿è¡Œ (UTCæ—¶é—´: 14:35)
    - cron: '35 14 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  auto-login:
    runs-on: ubuntu-22.04
    
    # æˆäºˆå·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹çš„æƒé™
    permissions:
      contents: write
      actions: write
    
    # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º15åˆ†é’Ÿ (åŒ…å«é‚®ç®±éªŒè¯ç è·å–æ—¶é—´)
    timeout-minutes: 15
    
    steps:
    - name: ğŸ”„ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ­ å®‰è£… Playwright æµè§ˆå™¨
      run: |
        playwright install chromium
        
    - name: ğŸŒ å®‰è£…æ—¥æ–‡å­—ä½“æ”¯æŒ
      run: |
        # æ›´æ–°åŒ…åˆ—è¡¨
        sudo apt-get update
        
        # å®‰è£…æ—¥æ–‡å­—ä½“åŒ…ï¼Œæ”¯æŒæ—¥æ–‡æ˜¾ç¤º
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        
        # éªŒè¯å­—ä½“å®‰è£…
        echo "ğŸ“ å·²å®‰è£…çš„æ—¥æ–‡å­—ä½“ï¼š"
        fc-list | grep -i "noto.*cjk" | head -5
        
    - name: ğŸš€ è¿è¡Œ XServer å®Œå…¨è‡ªåŠ¨åŒ–ç™»å½•
      env:
        # XServer ç™»å½•å‡­æ®
        XSERVER_EMAIL: ${{ secrets.XSERVER_EMAIL }}
        XSERVER_PASSWORD: ${{ secrets.XSERVER_PASSWORD }}
        CLOUD_MAIL: ${{ secrets.CLOUD_MAIL }}
        
        # ä»¥ä¸‹å˜é‡ç”±ç³»ç»Ÿå’Œè„šæœ¬è‡ªåŠ¨å¤„ç†ï¼š
        # - GITHUB_ACTIONS: GitHubè‡ªåŠ¨è®¾ç½®ä¸º"true"
        # - USE_HEADLESS: main.pyæ£€æµ‹åˆ°GITHUB_ACTIONSæ—¶è‡ªåŠ¨å¯ç”¨æ— å¤´æ¨¡å¼
        # - éªŒè¯ç ç­‰å¾…æ—¶é—´: main.pyä¸­è®¾å®šä¸º15ç§’
      run: |
        echo "ğŸš€ å¯åŠ¨XServer GAMEå®Œå…¨è‡ªåŠ¨åŒ–ç™»å½•æµç¨‹..."
        echo "ğŸ“§ XServeré‚®ç®±: $XSERVER_EMAIL"
        echo "ğŸ¤– è¿è¡Œç¯å¢ƒ: GitHub Actions (è‡ªåŠ¨æ— å¤´æ¨¡å¼)"
        echo "ğŸ“‚ å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ Pythonç‰ˆæœ¬: $(python --version)"
        echo "ğŸ­ æµè§ˆå™¨å¼•æ“: Playwright (Chromium)"
        echo ""
        
        # æ£€æŸ¥ä¸»è„šæœ¬æ–‡ä»¶
        echo "ğŸ“‹ æ£€æŸ¥ä¸»è„šæœ¬æ–‡ä»¶ï¼š"
        ls -la main.py
        echo ""
        
        # è¿è¡Œä¸»è„šæœ¬ï¼ˆåŒ…å«å®Œæ•´çš„ç™»å½•å’ŒéªŒè¯ç è·å–åŠŸèƒ½ï¼‰
        # åŸºäºPlaywright + Cloudmail API å®ç°å®Œå…¨è‡ªåŠ¨åŒ–
        python main.py
        
    - name: ğŸ“ æäº¤README.mdåˆ°ä»“åº“
      if: always()
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add README.md
        git diff --staged --quiet || git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–°ç»­æœŸçŠ¶æ€æŠ¥å‘Š [$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')]"
        git push
        
    - name: ğŸ“± å‘é€Telegramé€šçŸ¥
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # æå–README.mdä¸­çš„å…³é”®ä¿¡æ¯
        if [ -f "README.md" ]; then
          # æå–ç»­æœŸç»“æœ
          RENEWAL_STATUS=$(grep "ğŸ“Šç»­æœŸç»“æœï¼š" README.md | sed 's/.*ğŸ“Šç»­æœŸç»“æœï¼š\([^<]*\).*/\1/' | sed 's/<br>//')
          # æå–æ—§åˆ°æœŸæ—¶é—´
          OLD_DATE=$(grep "ğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´:" README.md | sed 's/.*ğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´: `\([^`]*\)`.*/\1/')
          # æå–æ–°åˆ°æœŸæ—¶é—´ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          NEW_DATE=$(grep "ğŸ•¡ï¸æ–°åˆ°æœŸæ—¶é—´:" README.md | sed 's/.*ğŸ•¡ï¸æ–°åˆ°æœŸæ—¶é—´: `\([^`]*\)`.*/\1/' || echo "")
        else
          RENEWAL_STATUS="â“Unknown"
          OLD_DATE="N/A"
          NEW_DATE=""
        fi
        
        # æ„å»ºé€šçŸ¥æ¶ˆæ¯
        MESSAGE="ğŸ¢Xserverç»­æœŸé€šçŸ¥
        ğŸ“…æ‰§è¡Œæ—¶é—´ï¼š$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        
        ğŸ–¥ï¸æœåŠ¡å™¨ï¼šğŸ‡¯ğŸ‡µXserver(Mc)
        ğŸ“Šç»­æœŸç»“æœï¼š${RENEWAL_STATUS}
        ğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´ï¼š${OLD_DATE}"
        
        # å¦‚æœæœ‰æ–°åˆ°æœŸæ—¶é—´ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
        if [ ! -z "$NEW_DATE" ]; then
          MESSAGE="${MESSAGE}
        ğŸ•¡ï¸æ–°åˆ°æœŸæ—¶é—´ï¼š${NEW_DATE}"
        fi
        
        MESSAGE="${MESSAGE}
        
        ğŸ“‹ è¯¦ç»†ä¿¡æ¯ï¼š
        ğŸ”— [æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        ğŸ“¸ [ä¸‹è½½æˆªå›¾](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)"
        
        # å‘é€Telegramæ¶ˆæ¯
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="${MESSAGE}" \
          -d parse_mode="Markdown"
    
    - name: ğŸ“± Telegramé€šçŸ¥è·³è¿‡æç¤º
      if: always() && (env.TELEGRAM_BOT_TOKEN == '' || env.TELEGRAM_CHAT_ID == '')
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: echo "â„¹ï¸ æœªé…ç½®Telegramå˜é‡ï¼Œè·³è¿‡é€šçŸ¥"
        
    - name: ğŸ“¸ ä¸Šä¼ è¿è¡Œç»“æœ
      if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ 
      uses: actions/upload-artifact@v4
      with:
        name: xserver-auto-login-results-${{ github.run_number }}
        path: |
          *.png
        retention-days: 7  # ä¿ç•™7å¤©
        
    - name: ğŸ§¹ æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
      uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        repository: ${{ github.repository }}
        older-than-seconds: 3600  # åˆ é™¤1å°æ—¶å‰çš„è®°å½•
